dist: trusty
language: python
python: 3.6
cache: 
  directories:
    - $HOME/.cache/pip
    - $VIRTUAL_ENV
    - node_modules
jobs:
  include:
    - &python-testing
      stage: test
      before_install: pip3 install pylint pydocstyle pytest-cov coveralls
      script: py.test --cov . && coveralls
    - <<: *python-testing
      script: pylint *.py subitize/ tests/*.py
    - <<: *python-testing
      script: pydocstyle *.py subitize/
    - stage: test
      before_install: npm install eslint
      script: ./node_modules/eslint/bin/eslint.js subitize/static/js/main.js
    - &push
      stage: stage
      if: branch = master
      install: skip
      script: skip
      deploy: &heroku
        provider: heroku
        app: subitest
        api_key:
          secure: "gD4qikYnGt5uHLa/KgKLW8Rvhekt103C3pTmaqTFzS9FxSSmgl3vcR1HkM3NH0dhUkhDW2VXnfjhfrBTb57CFrd1PzguUMvjZ4H6/8C3EARtnvLLFVoqEZ0VHTdtkuHKClGomDQN+VJYbnFg21Z0ng4TgprCqKhAKFtbrsWIk9f0jFVdSq9HVvGrYNCnBwdpkKjf8eucH3Qwyg/l2zuzDe8mRn+84DHVWu7j2pjERZLz3tSFaxs6fyb6G8NmqaKUg6Loy72YH6Fg79ERz01XWdDEdhHpWEvtGDb6CApw1dwl2DrVSFz3C6/BYyekhA+LItW8L2J0/DaoeIuyA10/DK49iQK36TeOkKl92KUELX2y9sy0WR5MffQ4d35dDaxa+WXgmQOFB35oHdbQfJem3q6v9IOLFwwbONq073AAKBUb5Gqec/MQmdxTMAEEiMFnt0zDGbMVJbVciszmBNGwmgLnzLIvO1N8CSNRfUMjMUAKJOay7uZFgOR5EfAyIhIdSCPXwWS8RIQ3p33semiZWa3HHXPk6Txt/7l9w79Uf1sO4ni6xYEtMd8BILkL85nCzFAZ7FBFJQYy6/JTLSDIEQcHCf4yLkDPz9QBCJ7zTwWMYExld40kXUxPHi2ivDs2bzqvKjqmTuPJmLbITgV6CahL5mrDF/68oPCqcNy12q8="
    - &test-push
      stage: test staging
      if: branch = master
      install: skip
      script: curl 'https://subitest.herokuapp.com/json/?department=COMP&instructor=Justin%20Li&semester=201701'
    - <<: *push
      stage: deploy
      if: branch = master AND type = push
      deploy:
        <<: *heroku
        app: subitize
    - <<: *test-push
      stage: test deployment
      if: branch = master AND type = push
      script: curl 'https://subitize.herokuapp.com/json/?department=COMP&instructor=Justin%20Li&semester=201701'
